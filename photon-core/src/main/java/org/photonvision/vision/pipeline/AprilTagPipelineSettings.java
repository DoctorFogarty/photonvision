/*
 * Copyright (C) Photon Vision.
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

package org.photonvision.vision.pipeline;

import com.fasterxml.jackson.annotation.JsonTypeName;
import org.photonvision.vision.apriltag.AprilTagFamily;
import org.photonvision.vision.target.TargetModel;

@JsonTypeName("AprilTagPipelineSettings")
public class AprilTagPipelineSettings extends AdvancedPipelineSettings {
    public AprilTagFamily tagFamily = AprilTagFamily.kTag36h11;
    public int decimate = 1;
    public double blur = 0;
    public int threads = 4; // Multiple threads seems to be better performance on most platforms
    public boolean debug = false;
    public boolean refineEdges = true;
    public int numIterations = 40;
    public int hammingDist = 0;
    public int decisionMargin = 35;
    public boolean doMultiTarget = false;
    public boolean doSingleTargetAlways = false;

    // ML-assisted detection settings
    public boolean useMLDetection = false;
    public double mlConfidenceThreshold = 0.5;
    public double mlNmsThreshold = 0.45;
    public double mlRoiExpansionFactor = 1.2;
    public boolean mlFallbackToTraditional = true;
    public String mlModelName = null;

    // Adaptive Tag Resizing (ATR) settings
    /** Enable adaptive tag resizing for ML-assisted detection */
    public boolean atrEnabled = true;
    /** Target dimension (pixels) for ATR resizing. Tags larger than this will be downscaled. */
    public int atrTargetDimension = 160;
    /** Minimum scale factor - prevents extreme downscaling. Default: 0.25 (4x max downscale) */
    public double atrMinScaleFactor = 0.25;
    /** Enable two-stage coarse-to-fine corner refinement (more accurate but slower) */
    public boolean atrCornerRefinementEnabled = false;
    /** Window size for cornerSubPix refinement (pixels around each corner) */
    public int atrRefinementWindowSize = 5;

    // 3d settings

    public AprilTagPipelineSettings() {
        super();
        pipelineType = PipelineType.AprilTag;
        outputShowMultipleTargets = true;
        targetModel = TargetModel.kAprilTag6p5in_36h11;
        cameraExposureRaw = 20;
        cameraAutoExposure = false;
        ledMode = false;
    }

    @Override
    public int hashCode() {
        final int prime = 31;
        int result = super.hashCode();
        result = prime * result + ((tagFamily == null) ? 0 : tagFamily.hashCode());
        result = prime * result + decimate;
        long temp;
        temp = Double.doubleToLongBits(blur);
        result = prime * result + (int) (temp ^ (temp >>> 32));
        result = prime * result + threads;
        result = prime * result + (debug ? 1231 : 1237);
        result = prime * result + (refineEdges ? 1231 : 1237);
        result = prime * result + numIterations;
        result = prime * result + hammingDist;
        result = prime * result + decisionMargin;
        result = prime * result + (doMultiTarget ? 1231 : 1237);
        result = prime * result + (doSingleTargetAlways ? 1231 : 1237);
        // ML-assisted detection fields
        result = prime * result + (useMLDetection ? 1231 : 1237);
        temp = Double.doubleToLongBits(mlConfidenceThreshold);
        result = prime * result + (int) (temp ^ (temp >>> 32));
        temp = Double.doubleToLongBits(mlNmsThreshold);
        result = prime * result + (int) (temp ^ (temp >>> 32));
        temp = Double.doubleToLongBits(mlRoiExpansionFactor);
        result = prime * result + (int) (temp ^ (temp >>> 32));
        result = prime * result + (mlFallbackToTraditional ? 1231 : 1237);
        result = prime * result + ((mlModelName == null) ? 0 : mlModelName.hashCode());
        // ATR fields
        result = prime * result + (atrEnabled ? 1231 : 1237);
        result = prime * result + atrTargetDimension;
        temp = Double.doubleToLongBits(atrMinScaleFactor);
        result = prime * result + (int) (temp ^ (temp >>> 32));
        result = prime * result + (atrCornerRefinementEnabled ? 1231 : 1237);
        result = prime * result + atrRefinementWindowSize;
        return result;
    }

    @Override
    public boolean equals(Object obj) {
        if (this == obj) return true;
        if (!super.equals(obj)) return false;
        if (getClass() != obj.getClass()) return false;
        AprilTagPipelineSettings other = (AprilTagPipelineSettings) obj;
        if (tagFamily != other.tagFamily) return false;
        if (decimate != other.decimate) return false;
        if (Double.doubleToLongBits(blur) != Double.doubleToLongBits(other.blur)) return false;
        if (threads != other.threads) return false;
        if (debug != other.debug) return false;
        if (refineEdges != other.refineEdges) return false;
        if (numIterations != other.numIterations) return false;
        if (hammingDist != other.hammingDist) return false;
        if (decisionMargin != other.decisionMargin) return false;
        if (doMultiTarget != other.doMultiTarget) return false;
        if (doSingleTargetAlways != other.doSingleTargetAlways) return false;
        // ML-assisted detection fields
        if (useMLDetection != other.useMLDetection) return false;
        if (Double.doubleToLongBits(mlConfidenceThreshold)
                != Double.doubleToLongBits(other.mlConfidenceThreshold)) return false;
        if (Double.doubleToLongBits(mlNmsThreshold) != Double.doubleToLongBits(other.mlNmsThreshold))
            return false;
        if (Double.doubleToLongBits(mlRoiExpansionFactor)
                != Double.doubleToLongBits(other.mlRoiExpansionFactor)) return false;
        if (mlFallbackToTraditional != other.mlFallbackToTraditional) return false;
        if (mlModelName == null) {
            if (other.mlModelName != null) return false;
        } else if (!mlModelName.equals(other.mlModelName)) return false;
        // ATR fields
        if (atrEnabled != other.atrEnabled) return false;
        if (atrTargetDimension != other.atrTargetDimension) return false;
        if (Double.doubleToLongBits(atrMinScaleFactor)
                != Double.doubleToLongBits(other.atrMinScaleFactor)) return false;
        if (atrCornerRefinementEnabled != other.atrCornerRefinementEnabled) return false;
        if (atrRefinementWindowSize != other.atrRefinementWindowSize) return false;
        return true;
    }
}
